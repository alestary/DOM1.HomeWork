<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="comments-list">
      </ul>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
          id="name-input"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
          id="comment-input"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id="add-button">Написать</button>
        </div>
      </div>
    </div>

    <script>
      "use strict";
      let comments = [
        {
          id: 1,
          name: "Глеб Фокин",
          date: "12.02.22 12:18",
          text: "Это будет первый комментарий на этой странице",
          likes: 3,
          isLiked: false
        },
        {
          id: 2,
          name: "Варвара Н.",
          date: "13.02.22 19:22",
          text: "Мне нравится как оформлена эта страница! ❤",
          likes: 75,
          isLiked: true
        }
      ];
      function escapeHtml(text) {
        if (typeof text !== 'string') return text;
        return text
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      }

      let replyingTo = null;

      function formatDate(date) {
        const day = date.getDate().toString().padStart(2, "0");
        const month = (date.getMonth() + 1).toString().padStart(2, "0");
        const year = date.getFullYear().toString().slice(-2);
        const hours = date.getHours().toString().padStart(2, "0");
        const minutes = date.getMinutes().toString().padStart(2, "0");
        return `${day}.${month}.${year} ${hours}:${minutes}`;
      }

      function renderComments() {
        const commentsList = document.getElementById("comments-list");
        
        const commentsHtml = comments.map((comment) => {
          const likeButtonClass = comment.isLiked ? "like-button -active-like" : "like-button";
          
          return `
            <li class="comment" data-id="${comment.id}">
              <div class="comment-header">
                <div>${escapeHtml(comment.name)}</div>
                <div>${comment.date}</div>
              </div>
              <div class="comment-body">
                <div class="comment-text">${escapeHtml(comment.text)}</div>
              </div>
              <div class="comment-footer">
                <div class="likes">
                  <span class="likes-counter">${comment.likes}</span>
                  <button class="${likeButtonClass}" data-id="${comment.id}"></button>
                </div>
              </div>
            </li>
          `;
        }).join("");

        commentsList.innerHTML = commentsHtml;
      }

      function initEventHandlers() {
        const commentsList = document.getElementById("comments-list");
        
        commentsList.addEventListener("click", (event) => {
          if (event.target.classList.contains("like-button")) {
            return;
          }
          
          const commentElement = event.target.closest(".comment");
          if (!commentElement) return;
          
          const commentId = Number(commentElement.dataset.id);
          const comment = comments.find(c => c.id === commentId);
          
          if (comment) {
            replyingTo = commentId;
            
            const replyText = `> ${comment.name}:\n${comment.text}\n\n`;
            
            const commentInput = document.getElementById("comment-input");
            commentInput.value = replyText;
            
            commentInput.focus();
            
            commentInput.scrollIntoView({ behavior: "smooth" });
          }
        });
        
        commentsList.addEventListener("click", (event) => {
          if (event.target.classList.contains("like-button")) {
            const commentId = Number(event.target.dataset.id);
            const commentIndex = comments.findIndex(comment => comment.id === commentId);
            
            if (commentIndex !== -1) {
              if (comments[commentIndex].isLiked) {
                comments[commentIndex].likes -= 1;
              } else {
                comments[commentIndex].likes += 1;
              }
              comments[commentIndex].isLiked = !comments[commentIndex].isLiked;
              
              renderComments();
            }
          }
        });
      }

      function addComment(name, text) {
        const escapedName = escapeHtml(name.trim());
        const escapedText = escapeHtml(text.trim());
        
        if (!escapedName || !escapedText) {
          alert("Пожалуйста, заполните оба поля");
          return;
        }

        const newComment = {
          id: comments.length > 0 ? Math.max(...comments.map(c => c.id)) + 1 : 1,
          name: escapedName,
          date: formatDate(new Date()),
          text: escapedText,
          likes: 0,
          isLiked: false,
        };
        comments.push(newComment);
        
        renderComments();

        replyingTo = null;
      }

      document.addEventListener("DOMContentLoaded", () => {
        renderComments();
        initEventHandlers();
      
        const nameInput = document.getElementById("name-input");
        const commentInput = document.getElementById("comment-input");
        const addButton = document.getElementById("add-button");
        
        addButton.addEventListener("click", () => {
          addComment(nameInput.value, commentInput.value);
          
          nameInput.value = "";
          commentInput.value = "";
          
          nameInput.focus();
        });
        
         commentInput.addEventListener("keydown", (event) => {
          if (event.ctrlKey && event.key === "Enter") {
            addComment(nameInput.value, commentInput.value);
            nameInput.value = "";
            commentInput.value = "";
            nameInput.focus();
          }
        });
        
        console.log("Приложение загружено! Лайки работают.");
      });
    </script>
  </body>
</html>